from extras.scripts import Script
from dcim.models import Device
from extras.models import JournalEntry
from utilities.forms.fields import DynamicModelChoiceField
from django.utils.timezone import now

class AddDeviceJournalEntry(Script):
    class Meta:
        name = "Add Journal Entry to Device"
        description = "Prompts the user to select a device and adds a journal entry."
        field_order = ['device', 'entry']

    device = DynamicModelChoiceField(
        queryset=Device.objects.all(),
        label="Select Device",
        required=True,
    )

    entry = Script.CharField(
        max_length=500,
        label="Journal Entry",
        required=True,
    )

    def run(self, data, commit):
        device = data['device']
        entry_text = data['entry']

        # Create the journal entry
        journal_entry = JournalEntry(
            assigned_object=device,
            assigned_object_type=device.get_content_type(),
            created=now(),
            kind="info",
            comments=entry_text
        )
        
        if commit:
            journal_entry.save()
            self.log_success(f"Journal entry added to device {device.name}")
        else:
            self.log_info(f"Journal entry would be added to device {device.name} (dry run).")

        return f"Journal entry added successfully: {entry_text}"
